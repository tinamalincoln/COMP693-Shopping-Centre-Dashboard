{% extends "layout.html" %}

{% block title %}Shopping Centre Search Result{% endblock %}

{% block content %}


{% if centre %}
<style>
  .full-height-container {
    display: flex;
    height: calc(100vh - 120px);
  }
  .info-panel {
    width: 33.33%;
    padding: 1rem;
    overflow-y: auto;
    background-color: #f8f9fa;
    border-right: 1px solid #ddd;
  }
  #map {
    width: 66.66%;
    height: 100%;
  }
  @media (max-width: 768px) {
    .full-height-container {
      flex-direction: column;
      height: auto;
    }
    .info-panel, #map {
      width: 100%;
      height: 400px;
    }
  }
</style>

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} alert-dismissible fade show mb-4" role="alert">
        <i class="fas fa-{% if category == 'success' %}check-circle{% else %}exclamation-circle{% endif %} me-2"></i>
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<div class="full-height-container">
  <!-- Info panel -->
<div class="info-panel">
  <h4 class="mb-3"><i class="fas fa-store"></i> {{ centre.name }}</h4>

  {% if centre.image_filename %}
    <img src="{{ url_for('static', filename='uploads/centre_photo/' ~ centre.image_filename) }}"
         alt="Photo of {{ centre.name }}"
         class="img-fluid rounded mb-3">
  {% else %}
    <p><em>No image available for this centre.</em></p>
  {% endif %}


  <div class="card mb-3">
    <div class="card-header bg-primary text-white">
      <i class="fas fa-info-circle"></i> General Information
    </div>
    <ul class="list-group list-group-flush">
      <li class="list-group-item"><i class="fas fa-map-marker-alt me-2"></i><strong>Location:</strong> {{ centre.location }}</li>
      <li class="list-group-item"><i class="fas fa-tags me-2"></i><strong>Classification:</strong> {{ centre.classification }}</li>
      <li class="list-group-item"><i class="fas fa-building me-2"></i><strong>Centre Type:</strong> {{ centre.centre_type }}</li>
      <li class="list-group-item"><i class="fas fa-calendar-alt me-2"></i><strong>Date Opened:</strong> {{ centre.date_opened or 'N/A' }}</li>
    </ul>
  </div>

  <div class="card mb-3">
    <div class="card-header bg-success text-white">
      <i class="fas fa-ruler-combined"></i> Size & Facilities
    </div>
    <ul class="list-group list-group-flush">
      <li class="list-group-item"><i class="fas fa-expand-arrows-alt me-2"></i><strong>Total Retail Space:</strong> {{ centre.total_retail_space or 'N/A' }} m²</li>
      <li class="list-group-item"><i class="fas fa-vector-square me-2"></i><strong>Site Area:</strong> {{ centre.site_area_ha or 'N/A' }} ha</li>
      <li class="list-group-item"><i class="fas fa-layer-group me-2"></i><strong>Levels:</strong> {{ centre.levels or 'N/A' }}</li>
    </ul>
  </div>

  <div class="card mb-3">
    <div class="card-header bg-info text-white">
      <i class="fas fa-parking"></i> Parking & Development
    </div>
    <ul class="list-group list-group-flush">
      <li class="list-group-item"><i class="fas fa-car me-2"></i><strong>Covered Parking:</strong> {{ centre.covered_parking_num or 0 }}</li>
      <li class="list-group-item"><i class="fas fa-car-side me-2"></i><strong>Uncovered Parking:</strong> {{ centre.uncovered_parking_num or 0 }}</li>
      <li class="list-group-item"><i class="fas fa-tools me-2"></i><strong>Redevelopments:</strong> {{ centre.redevelopments or 'N/A' }}</li>
    </ul>
  </div>
  
  <div class="text-center my-3">
    <a href="{{ classic_map_url }}"
       target="_blank" 
       class="btn btn-outline-primary">
      <i class="fas fa-users"></i> View Population Reach on ORS Map
    </a>
  </div>

  <!-- Edit Centre Button -->
   <div class="text-end">
    <button class="btn btn-warning" data-bs-toggle="offcanvas" data-bs-target="#editCentreCanvas">
      <i class="fas fa-edit"></i> Edit Centre
    </button>
  </div>
</div>

  <!-- Map -->
  <div id="map"></div>
</div>

<!-- Offcanvas Edit Form -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="editCentreCanvas" aria-labelledby="editCentreLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="editCentreLabel">Edit {{ centre.name }}</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <form id="edit-form" action="{{ url_for('edit_centre', centre_id=centre['id']) }}" method="POST" enctype="multipart/form-data">
      <div class="mb-3">
        <label class="form-label">Name</label>
        <input type="text" name="name" class="form-control" value="{{ centre.name }}">
      </div>
      <div class="mb-3">
        <label class="form-label">OSM Name</label>
        <input type="text" name="osm_name" class="form-control" value="{{ centre.osm_name }}">
      </div>
      <div class="mb-3">
        <label class="form-label">Location</label>
        <input type="text" name="location" class="form-control" value="{{ centre.location }}">
      </div>
      <div class="mb-3">
        <label class="form-label">Date Opened</label>
        {% if centre.date_opened %}
           <input type="date" name="date_opened" class="form-control" value="{{ centre.date_opened }}">
        {% else %}
           <input type="date" name="date_opened" class="form-control" value="">
           <div class="form-text text-muted">Current value: N/A</div>
        {% endif %}
      </div>
      <div class="mb-3">
        <label class="form-label">Site Area (ha)</label>
        <input type="number" step="0.0001" name="site_area_ha" class="form-control" value="{{ centre.site_area_ha }}">
      </div>
      <div class="mb-3">
        <label class="form-label">Covered Parking</label>
        <input type="number" name="covered_parking_num" class="form-control" value="{{ centre.covered_parking_num }}">
      </div>
      <div class="mb-3">
        <label class="form-label">Uncovered Parking</label>
        <input type="number" name="uncovered_parking_num" class="form-control" value="{{ centre.uncovered_parking_num }}">
      </div>
      <div class="mb-3">
        <label class="form-label">Redevelopments</label>
        <textarea name="redevelopments" class="form-control">{{ centre.redevelopments }}</textarea>
      </div>
      <div class="mb-3">
        <label class="form-label">Levels</label>
        <input type="number" name="levels" class="form-control" value="{{ centre.levels }}">
      </div>
      <div class="mb-3">
        <label class="form-label">Total Retail Space (m²)</label>
        <input type="number" step="0.01" name="total_retail_space" class="form-control" value="{{ centre.total_retail_space }}">
      </div>
      <div class="mb-3">
        <label class="form-label">Replace Centre Image</label>
        <input type="file" name="image" class="form-control">
      </div>
      <div class="offcanvas-footer text-end">
        <button type="submit" class="btn btn-success" id="save-btn" disabled>Save Changes</button>
      </div>
    </form>

    <script>
    document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("edit-form");
    const saveBtn = document.getElementById("save-btn");

    // Store the initial state of the form
    const initialData = new FormData(form);
    const imageInput = form.querySelector('input[type="file"]');

    function isFormChanged() {
      const currentData = new FormData(form);
      for (const [key, value] of currentData.entries()) {
        if (initialData.get(key) !== value) return true;
      }
      // If image selected, that's also a change
      if (imageInput && imageInput.files.length > 0) return true;
      return false;
    }

    form.addEventListener("input", () => {
      saveBtn.disabled = !isFormChanged();
    });

    imageInput.addEventListener("change", () => {
      saveBtn.disabled = !isFormChanged();
    });
  });
   </script>
  </div>
</div>

<!-- Map Script -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    var lat = '{{ lat }}';
    var lon = '{{ lon }}';
    var centreName = '{{ centre.name | tojson }}';

    var map = L.map('map').setView([lat, lon], 16);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors'
    }).addTo(map);

    L.marker([lat, lon]).addTo(map)
      .bindPopup(centreName)
      .openPopup();
  });
</script>



{% elif error %}
<div class="alert alert-danger mt-3">{{ error }}</div>
{% endif %}

{% endblock %}
