{% extends "layout.html" %}

{% block title %}{{ centre.name }} Details{% endblock %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item">
      <a href="{{ url_for('city_summary') }}"><i class="fas fa-home"></i></a>
    </li>
    <li class="breadcrumb-item">
      <a href="{{ url_for('city_summary') }}">City Summary</a>
    </li>
    {% if centre.city_name %}
      <li class="breadcrumb-item">
        <a href="{{ url_for('centrelist', city=centre.city_name) }}">{{ centre.city_name }}</a>
      </li>
    {% endif %}
    <li class="breadcrumb-item active" aria-current="page">{{ centre.name }}</li>
  </ol>
</nav>
{% endblock %}


{% block content %}
<!-- Page-specific CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/centredetails.css') }}">

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show mb-4" role="alert">
            <i class="fas fa-{% if category == 'success' %}check-circle{% else %}exclamation-circle{% endif %} me-2"></i>
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

{% if centre %}
<div class="full-height-container">
  <!-- Left: Info panel -->
  <div class="info-panel">
    <!-- Title + inline actions -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4 class="mb-0">
        <i class="fas fa-store me-2"></i>{{ centre.name }}
      </h4>
      <div class="d-flex justify-content-end gap-2 mt-2">
        {% if can_edit %}
          <button type="button" class="btn btn-outline-warning btn-sm me-2"
                  data-bs-toggle="offcanvas"
                  data-bs-target="#editCentreCanvas"
                  title="Edit this centre"
                  data-bs-toggle="tooltip" data-bs-placement="bottom">
            <i class="fas fa-edit"></i>
          </button>
        {% endif %} 

        {% if can_delete %}
          <button type="button" class="btn btn-outline-danger btn-sm"
                  data-bs-toggle="modal"
                  data-bs-target="#confirmDeleteModal"
                  title="Delete this centre"
                  data-bs-toggle="tooltip" data-bs-placement="bottom">
            <i class="fas fa-trash"></i>
          </button>
        {% endif %}
      </div>
    </div>


    {% if centre.image_filename %}
      <img src="{{ url_for('static', filename='uploads/centre_photo/' ~ centre.image_filename) }}"
           alt="Photo of {{ centre.name }}"
           class="img-fluid rounded mb-3">
    {% else %}
      <p><em>No image available for this centre.</em></p>
    {% endif %}

    <div class="card mb-3">
      <div class="card-header bg-primary text-white">
        <i class="fas fa-info-circle"></i> General Information
      </div>
      <ul class="list-group list-group-flush">
        <li class="list-group-item"><i class="fas fa-map-marker-alt me-2"></i><strong>Location:</strong> {{ centre.location }}</li>
        <li class="list-group-item"><i class="fas fa-tags me-2"></i><strong>Classification:</strong> {{ centre.classification }}</li>
        <li class="list-group-item"><i class="fas fa-building me-2"></i><strong>Centre Type:</strong> {{ centre.centre_type }}</li>
        <li class="list-group-item"><i class="fas fa-calendar-alt me-2"></i><strong>Date Opened:</strong> {{ centre.date_opened or 'N/A' }}</li>
      </ul>
    </div>

    <div class="card mb-3">
      <div class="card-header bg-success text-white">
        <i class="fas fa-ruler-combined"></i> Size & Facilities
      </div>
      <ul class="list-group list-group-flush">
        <li class="list-group-item"><i class="fas fa-expand-arrows-alt me-2"></i><strong>Total Retail Space:</strong> {{ centre.total_retail_space or 'N/A' }} m²</li>
        <li class="list-group-item"><i class="fas fa-vector-square me-2"></i><strong>Site Area:</strong> {{ centre.site_area_ha or 'N/A' }} ha</li>
        <li class="list-group-item"><i class="fas fa-layer-group me-2"></i><strong>Levels:</strong> {{ centre.levels or 'N/A' }}</li>
      </ul>
    </div>

    <div class="card mb-3">
      <div class="card-header bg-info text-white">
        <i class="fas fa-parking"></i> Parking & Development
      </div>
      <ul class="list-group list-group-flush">
        <li class="list-group-item"><i class="fas fa-car me-2"></i><strong>Covered Parking:</strong> {{ centre.covered_parking_num or 0 }}</li>
        <li class="list-group-item"><i class="fas fa-car-side me-2"></i><strong>Uncovered Parking:</strong> {{ centre.uncovered_parking_num or 0 }}</li>
        <li class="list-group-item"><i class="fas fa-tools me-2"></i><strong>Redevelopments:</strong> {{ centre.redevelopments or 'N/A' }}</li>
      </ul>
    </div>

    <div class="text-center my-3">
      <a href="{{ classic_map_url }}" target="_blank" class="btn btn-outline-primary">
        <i class="fas fa-users"></i> View Population Reach on ORS Map
      </a>
    </div>
  </div>

  <!-- Map -->
  <div id="map"></div>
</div>

<!-- Confirm Delete Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-danger">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmDeleteLabel">Delete “{{ centre.name }}”?</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-0">This will permanently remove the centre and its image. This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form action="{{ url_for('delete_centre', centre_id=centre['id']) }}" method="POST">
          <button type="submit" class="btn btn-danger">
            <i class="fas fa-trash"></i> Yes, delete
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Offcanvas Edit Form -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="editCentreCanvas" aria-labelledby="editCentreLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="editCentreLabel"><i class="fas fa-pen-to-square me-2 text-warning"></i>Edit {{ centre.name }}</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <form id="edit-form" action="{{ url_for('edit_centre', centre_id=centre['id']) }}" method="POST" enctype="multipart/form-data">
      <div class="mb-3">
        <label class="form-label"><i class="fas fa-store me-2"></i>Centre Name</label>
        <input type="text" name="name" class="form-control" value="{{ centre.name }}">
      </div>
      <div class="mb-3">
        <label class="form-label"><i class="fas fa-edit me-2"></i>OSM Name</label>
        <input type="text" name="osm_name" class="form-control" value="{{ centre.osm_name }}">
      </div>
      <div class="mb-3">
        <label class="form-label"><i class="fas fa-map-marker-alt me-2"></i>Location</label>
        <input type="text" name="location" class="form-control" value="{{ centre.location }}">
      </div>
      <div class="mb-3">
        <label class="form-label"><i class="fas fa-calendar-alt me-2"></i>Date Opened</label>
        {% set today = datetime.utcnow().date() %}
        {% if centre.date_opened %}
          <input type="date" name="date_opened" class="form-control" 
                 value="{{ centre.date_opened }}" max="{{ today }}">
        {% else %}
          <input type="date" name="date_opened" class="form-control" 
                 value="" max="{{ today }}">
          <div class="form-text text-muted">Current value: N/A</div>
        {% endif %}
      </div>
      <div class="mb-3">
        <label class="form-label"><i class="fas fa-vector-square me-2"></i>Site Area (ha)</label>
        <input type="number" min="0" step="0.0001" name="site_area_ha" class="form-control" value="{{ centre.site_area_ha }}">
      </div>
      <div class="mb-3">
        <label class="form-label"><i class="fas fa-car me-2"></i>Covered Parking</label>
        <input type="number" min="0" step="1" name="covered_parking_num" class="form-control" value="{{ centre.covered_parking_num }}" >
      </div>
      <div class="mb-3">
        <label class="form-label"><i class="fas fa-car-side me-2"></i>Uncovered Parking</label>
        <input type="number" min="0" step="1" name="uncovered_parking_num" class="form-control" value="{{ centre.uncovered_parking_num }}" >
      </div>
      <div class="mb-3">
        <label class="form-label"><i class="fas fa-tools me-2"></i>Redevelopments</label>
        <textarea name="redevelopments" class="form-control">{{ centre.redevelopments }}</textarea>
      </div>
      <div class="mb-3">
        <label class="form-label"><i class="fas fa-layer-group me-2"></i>Levels</label>
        <input type="number" min="0" step="1" name="levels" class="form-control" value="{{ centre.levels }}" >
      </div>
      <div class="mb-3">
        <label class="form-label"><i class="fas fa-expand-arrows-alt me-2"></i>Total Retail Space (m²)</label>
        <input type="number" min="0" step="0.01" name="total_retail_space" class="form-control" value="{{ centre.total_retail_space }}">
      </div>
      <div class="mb-3">
        <label class="form-label"><i class="fas fa-upload me-2"></i>Replace Centre Image</label>
        <input type="file" name="image" class="form-control">
      </div>
      <div class="offcanvas-footer text-end">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="offcanvas">Cancel</button>
        <button type="submit" class="btn btn-success" id="save-btn" disabled><i class="fas fa-save me-1"></i>Save Changes</button>
      </div>
    </form>
  </div>
</div>

<!-- Page-specific JS -->
<script src="{{ url_for('static', filename='js/centredetails.js') }}?v={{ timestamp|default(0) }}"></script>

<!-- Map Script -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    var lat = '{{ lat }}';
    var lon = '{{ lon }}';
    var centreName = '{{ centre.name | tojson }}';

    var map = L.map('map').setView([lat, lon], 16);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors'
    }).addTo(map);

    L.marker([lat, lon]).addTo(map)
      .bindPopup(centreName)
      .openPopup();
  });
</script>

{% elif error %}
  <div class="alert alert-danger mt-3">{{ error }}</div>
{% endif %}
{% endblock %}
