{% extends "layout.html" %}
{% block title %}City Summary{% endblock %}

{% set active_page = 'city_summary' %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item">
      <a href="{{ url_for('city_summary') }}"><i class="fas fa-home"></i></a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">City Summary</li>
  </ol>
</nav>
{% endblock %}

{% block content %}

<link rel="stylesheet" href="{{ url_for('static', filename='css/citysummary.css') }}?v=1.0">

<div class="row justify-content-center mb-4">
  <div class="col-lg-8 text-center">
    <h2 class="display-5 mb-3"><i class="fas fa-city me-2"></i>City Summary</h2>
    <p class="lead text-muted">List of cities and number of shopping centres</p>
    <hr class="border-primary mx-auto" style="width: 100px;">
  </div>
</div>

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="mb-3">
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          <i class="fas fa-{% if category == 'success' %}check-circle{% else %}exclamation-circle{% endif %} me-2"></i>
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<!-- Search Bar -->
<form method="get" action="{{ url_for('city_summary') }}" class="mb-4 d-flex justify-content-center">
  <div class="input-group" style="max-width: 500px; width: 100%;">
    <input type="text" name="q" class="form-control" placeholder="Search city..."
           value="{{ request.args.get('q', '') }}">
    <button class="btn btn-primary" type="submit">
      <i class="fas fa-search me-1"></i> Search
    </button>
    {% if request.args.get('q') %}
      <a href="{{ url_for('city_summary') }}" class="btn btn-outline-secondary">
        <i class="fas fa-times"></i> Clear
      </a>
    {% endif %}
  </div>
</form>

<div class="row g-4">
  {% for city in cities %}
    <div class="col-12 col-sm-6 col-md-4 col-lg-3">
      <div class="card city-card shadow-sm h-100 border-primary position-relative">

        <!-- City image -->
        <img
          src="{{ city.image_url }}"
          class="card-img-top"
          alt="{{ city.name }} image"
          onerror="this.onerror=null;this.src='{{ city.fallback_url }}';"
        >

        <div class="card-body text-center">
          <!-- City name (click to list centres) -->
          <h5 class="card-title text-primary mb-2">
            <a href="{{ url_for('centrelist', city=city.city_name) }}"
               class="text-decoration-none text-primary">
              <i class="fas fa-city me-2"></i>{{ city.city_name }}
            </a>
          </h5>

          <p class="card-text fs-4 fw-bold text-dark mb-1">{{ city.mall_count }}</p>
          <small class="text-muted">Shopping Centres</small>
        </div>

        <!-- Card actions (Edit + Delete) -->
        <div class="card-footer bg-transparent border-0 d-flex justify-content-end gap-2 pt-0 pb-3 pe-3">
          <!-- Edit -->
          <button class="btn btn-outline-warning btn-sm"
                  data-bs-toggle="offcanvas"
                  data-bs-target="#editCityCanvas{{ city.id }}"
                  data-bs-placement="bottom"
                  title="Edit city">
            <i class="fas fa-edit"></i>
          </button>

          <!-- Delete -->
          <button class="btn btn-outline-danger btn-sm"
                  data-bs-toggle="modal"
                  data-bs-target="#confirmDeleteCityModal{{ city.id }}"
                  data-bs-placement="bottom"
                  title="Delete city">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Offcanvas Edit City -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="editCityCanvas{{ city.id }}" aria-labelledby="editCityLabel{{ city.id }}">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="editCityLabel{{ city.id }}">
          <i class="fas fa-pen-to-square me-2 text-warning"></i>Edit “{{ city.city_name }}”
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>

      <div class="offcanvas-body">
        <form id="edit-city-form-{{ city.id }}"
              action="{{ url_for('edit_city', city_id=city.id) }}"
              method="POST" enctype="multipart/form-data">

          <!-- Name -->
          <div class="mb-3">
            <label class="form-label"><i class="fas fa-tag me-2"></i>City Name</label>
            <input type="text" name="city_name" class="form-control" value="{{ city.city_name }}" required>
          </div>

          <!-- Current image preview -->
          <div class="mb-3">
            <label class="form-label"><i class="fas fa-image me-2"></i>Current Image</label>
            <div class="border rounded p-2 text-center">
              <img src="{{ city.image_url }}"
                   alt="Current {{ city.city_name }} image"
                   onerror="this.onerror=null;this.src='{{ city.fallback_url }}';"
                   class="img-fluid rounded"
                   style="max-height: 180px;">
            </div>
          </div>

          <!-- Replace image -->
          <div class="mb-3">
            <label class="form-label"><i class="fas fa-upload me-2"></i>Replace City Image</label>
            <input type="file" name="image" class="form-control" accept="image/*">
            <div class="form-text">JPG/PNG recommended. A new upload will replace the existing image.</div>
          </div>

          <!-- Footer actions -->
          <div class="d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="offcanvas">Cancel</button>
            <button type="submit" class="btn btn-success" id="save-city-btn-{{ city.id }}" disabled>
              <i class="fas fa-save me-1"></i> Save Changes
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div class="modal fade" id="confirmDeleteCityModal{{ city.id }}" tabindex="-1"
         aria-labelledby="confirmDeleteCityLabel{{ city.id }}" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-danger">
          <div class="modal-header">
            <h5 class="modal-title" id="confirmDeleteCityLabel{{ city.id }}">
              Delete “{{ city.city_name }}”?
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            This will remove the city and all of its shopping centres. This action cannot be undone.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <form action="{{ url_for('delete_city', city_id=city.id) }}" method="POST">
              <button type="submit" class="btn btn-danger">
                <i class="fas fa-trash"></i> Yes, delete
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

  {% else %}
    <div class="col-12">
      <div class="alert alert-warning text-center">
        No cities found.
      </div>
    </div>
  {% endfor %}
</div>

<!-- Pagination -->
{% if total_pages > 1 %}
  {% set q = request.args.get('q') %}
  <div class="d-flex justify-content-center mt-4">
    <ul class="pagination pagination-sm">

      <!-- Previous -->
      <li class="page-item {% if page <= 1 %}disabled{% endif %}">
        <a class="page-link"
           href="{{ url_for('city_summary', page=page-1, per_page=per_page, q=q) }}">&laquo;</a>
      </li>

      <!-- Page numbers -->
      {% for p in range(1, total_pages+1) %}
        <li class="page-item {% if p == page %}active{% endif %}">
          <a class="page-link"
             href="{{ url_for('city_summary', page=p, per_page=per_page, q=q) }}">{{ p }}</a>
        </li>
      {% endfor %}

      <!-- Next -->
      <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
        <a class="page-link"
           href="{{ url_for('city_summary', page=page+1, per_page=per_page, q=q) }}">&raquo;</a>
      </li>

    </ul>
  </div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function () {
  // Enable tooltips
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));

  // Enable/disable Save buttons when a specific offcanvas form changes
  const forms = document.querySelectorAll('form[id^="edit-city-form-"]');
  forms.forEach(form => {
    const saveBtn = form.querySelector('button[id^="save-city-btn-"]');
    if (!saveBtn) return;

    const initial = new FormData(form);
    const fileInput = form.querySelector('input[type="file"]');

    function isChanged() {
      const current = new FormData(form);
      for (const [k, v] of current.entries()) {
        if (k === 'image') continue; // file handled separately
        if (initial.get(k) !== v) return true;
      }
      return fileInput && fileInput.files && fileInput.files.length > 0;
    }

    const updateState = () => { saveBtn.disabled = !isChanged(); };

    form.addEventListener('input', updateState);
    if (fileInput) fileInput.addEventListener('change', updateState);
    updateState();
  });
});
</script>

{% endblock %}
